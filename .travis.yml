language: python
python: 3.5
sudo: false
addons:
  postgresql: "9.4"
  apt:
    packages:
      - gfortran
      - gnuplot
      - wget
      - redis

services:
  - redis

install:
  - git submodule update --init
  - cd ./mercury
  - ./compile.sh
  - cd -
  - pip install -r reqs.pip
  - pip install coverage pytest==2.8.3

before_script:
  - cd ./catalog
  - wget http://hamilton.dm.unipi.it/~astdys2/catalogs/allnum.cat
  - cd -
  - mkdir axis
  - cd axis
  - wget https://raw.githubusercontent.com/smirik/Three-body-resonances/master/axis/resonances
  - wget https://raw.githubusercontent.com/smirik/Three-body-resonances/two-body-resonances/axis/resonances -O res_J
  - cd -
  - psql -c 'create database resonances;' -U postgres
  - psql -c 'create database resonances_unittest;' -U postgres
  - cp alembic.ini.dist alembic.ini
  - cp alembic.ini.dist alembic.test.ini
  - sed -i.bak -r -e 's/^# sqlalchemy.url(.*)/sqlalchemy.url = postgresql:\/\/postgres@localhost\/resonances/g' alembic.ini
  - sed -i.bak -r -e 's/^# sqlalchemy.url(.*)/sqlalchemy.url = postgresql:\/\/postgres@localhost\/resonances_unittest/g' alembic.test.ini
  - alembic upgrade head
  - alembic -c ./alembic.test.ini upgrade head

script:
  - python ./main.py --help
  - python ./main.py calc
  - python ./main.py load-resonances --start=1 --stop=101 --file=axis/res_J JUPITER
  - python ./main.py load-resonances --start=1 --stop=101 --file=axis/resonances JUPITER SATURN
  - python ./main.py find --phase-storage=FILE JUPITER
  - python ./main.py find JUPITER SATURN
  - python ./main.py plot --phase-storage=FILE JUPITER
  - python ./main.py plot JUPITER SATURN
  - python ./main.py package --res=1 --compress=1 --aei=1
  - python ./main.py clear-phases --start=1 --stop=101 JUPITER
  - python ./main.py clear-phases --start=1 --stop=101 JUPITER SATURN
  - python ./main.py librations
  - coverage run --omit='/home/travis/virtualenv/*,./tests/*' -m pytest `find ./tests -name '*.py'`

after_success:
  - coverage report -m
